<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>标注任务管理 - RockAnnotator</title>
    <!-- Bootstrap 5 CSS -->
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome 图标 -->
    <link rel="stylesheet" href="/css/all.min.css">
    <!-- 自定义样式 -->
    <link href="/admin/css/style.css" rel="stylesheet">
</head>
<body>
    <div id="admin-navbar"></div>
    
    <div class="container-fluid">
        <!-- 页面标题 -->
        <div class="row dashboard-header mt-4">
            <div class="col-12">
                <h1>
                    <i class="fas fa-tasks me-2"></i>标注任务管理
                </h1>
                <p class="text-muted">查看和管理所有标注任务</p>
            </div>
        </div>
        
        <!-- 筛选和控制区域 -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <label for="statusFilter" class="form-label">任务状态</label>
                                <select class="form-select" id="statusFilter">
                                    <option value="">全部状态</option>
                                    <option value="pending">待标注</option>
                                    <option value="completed">已标注</option>
                                </select>
                            </div>
                            
                            <div class="col-md-3">
                                <label for="pageSize" class="form-label">每页显示</label>
                                <select class="form-select" id="pageSize">
                                    <option value="10">10条</option>
                                    <option value="20">20条</option>
                                    <option value="50">50条</option>
                                    <option value="100">100条</option>
                                </select>
                            </div>
                            
                            <div class="col-md-3">
                                <button id="refreshBtn" class="btn btn-outline-primary mt-4">
                                    <i class="fas fa-sync-alt me-1"></i>刷新
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 任务列表 -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-list me-2"></i>任务列表
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>图片文件</th>
                                        <th>尺寸</th>
                                        <th>状态</th>
                                        <th>导出状态</th>
                                        <th>创建时间</th>
                                        <th>完成时间</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="tasksTableBody">
                                    <tr>
                                        <td colspan="8" class="text-center">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">加载中...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- 分页控件 -->
                        <nav aria-label="任务列表分页">
                            <ul class="pagination justify-content-center" id="pagination">
                                <!-- 分页控件将通过JavaScript动态生成 -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 任务详情模态框 -->
    <div class="modal fade" id="taskDetailModal" tabindex="-1" aria-labelledby="taskDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="taskDetailModalLabel">任务详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="taskDetailBody">
                    <!-- 任务详情将通过JavaScript动态加载 -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 删除确认模态框 -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteConfirmModalLabel">确认删除</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>您确定要删除这个标注任务吗？此操作不可撤销。</p>
                    <p>删除任务将同时删除关联的图片文件和数据库记录。</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">确认删除</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 重置确认模态框 -->
    <div class="modal fade" id="resetConfirmModal" tabindex="-1" aria-labelledby="resetConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="resetConfirmModalLabel">确认重置</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>确认要重置该任务吗？此操作将删除与任务相关的标注信息并把任务恢复为“待标注”状态。</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-warning" id="confirmResetBtn">确认重置</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS 和依赖 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Font Awesome 图标 -->
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <!-- 公共 Admin JS（负责加载统一导航等） -->
    <script src="/admin/js/main.js"></script>
    
    <script>
        // 全局变量
        let currentPage = 1;
        let currentPageSize = 10;
        let currentStatus = '';
        let currentTaskId = null;
        
        // DOM加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 绑定事件监听器
            document.getElementById('statusFilter').addEventListener('change', function() {
                currentPage = 1; // 重置到第一页
                loadTasks();
            });
            
            document.getElementById('pageSize').addEventListener('change', function() {
                currentPageSize = parseInt(this.value);
                currentPage = 1; // 重置到第一页
                loadTasks();
            });
            
            document.getElementById('refreshBtn').addEventListener('click', function() {
                loadTasks(currentPage);
            });
            
            // 设置默认每页显示数量
            document.getElementById('pageSize').value = currentPageSize;
            
            // 初始加载任务列表
            loadTasks();
        });
        
        // 加载任务列表
        function loadTasks(page = 1) {
            currentPage = page;
            currentStatus = document.getElementById('statusFilter').value;
            currentPageSize = parseInt(document.getElementById('pageSize').value);
            
            // 显示加载状态
            document.getElementById('tasksTableBody').innerHTML = `
                <tr>
                    <td colspan="7" class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                    </td>
                </tr>
            `;
            
            // 构造查询参数
            const params = new URLSearchParams();
            params.append('page', currentPage);
            params.append('pageSize', currentPageSize);
            if (currentStatus) {
                params.append('status', currentStatus);
            }
            
            // 发起API请求
            fetch(`/api/admin/tasks?${params.toString()}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderTasks(data.data.tasks, data.data.pagination);
                    } else {
                        showError('加载任务列表失败: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showError('网络错误，请稍后重试');
                });
        }
        
        // 渲染任务列表
        function renderTasks(tasks, pagination) {
            const tbody = document.getElementById('tasksTableBody');
            
            if (tasks.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center">暂无任务数据</td>
                    </tr>
                `;
                document.getElementById('pagination').innerHTML = '';
                return;
            }
            
            // 清空表格
            tbody.innerHTML = '';
            
            // 填充数据
            tasks.forEach(task => {
                const statusBadge = task.status === 'completed' 
                    ? '<span class="badge bg-success">已标注</span>' 
                    : '<span class="badge bg-warning">待标注</span>';
                
                const completedAt = task.completed_at 
                    ? new Date(task.completed_at).toLocaleString() 
                    : '-';
                
                const row = document.createElement('tr');
                const exportedBadge = task.exported == 1
                    ? '<span class="badge bg-success">已导出</span>'
                    : '<span class="badge bg-secondary">未导出</span>';

                row.innerHTML = `
                    <td>${task.id}</td>
                    <td>${task.filename}</td>
                    <td>${task.width} x ${task.height}</td>
                    <td>${statusBadge}</td>
                    <td>${exportedBadge}</td>
                    <td>${new Date(task.created_at).toLocaleString()}</td>
                    <td>${completedAt}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary view-detail" data-id="${task.id}">
                            <i class="fas fa-eye"></i> 查看
                        </button>
                        ${task.status === 'completed' ? `
                        <button class="btn btn-sm btn-outline-warning ms-1 reset-task" data-id="${task.id}">
                            <i class="fas fa-undo"></i> 重置
                        </button>
                        ` : ''}
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            // 绑定查看详情按钮事件
            document.querySelectorAll('.view-detail').forEach(button => {
                button.addEventListener('click', function() {
                    const taskId = this.getAttribute('data-id');
                    showTaskDetail(taskId);
                });
            });

            // 绑定重置按钮事件（仅在已完成任务出现）
            document.querySelectorAll('.reset-task').forEach(button => {
                button.addEventListener('click', function() {
                    const taskId = this.getAttribute('data-id');
                    showResetConfirm(taskId);
                });
            });
            
            // 渲染分页控件
            renderPagination(pagination);
        }
        
        // 渲染分页控件
        function renderPagination(pagination) {
            const paginationEl = document.getElementById('pagination');
            paginationEl.innerHTML = '';
            
            if (pagination.totalPages <= 1) {
                return;
            }
            
            // 上一页按钮
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${pagination.page === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `
                <a class="page-link" href="#" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            `;
            if (pagination.page > 1) {
                prevLi.querySelector('a').addEventListener('click', function(e) {
                    e.preventDefault();
                    loadTasks(pagination.page - 1);
                });
            }
            paginationEl.appendChild(prevLi);
            
            // 页码按钮
            for (let i = 1; i <= pagination.totalPages; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === pagination.page ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                
                if (i !== pagination.page) {
                    li.querySelector('a').addEventListener('click', function(e) {
                        e.preventDefault();
                        loadTasks(i);
                    });
                }
                
                paginationEl.appendChild(li);
            }
            
            // 下一页按钮
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${pagination.page === pagination.totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `
                <a class="page-link" href="#" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            `;
            if (pagination.page < pagination.totalPages) {
                nextLi.querySelector('a').addEventListener('click', function(e) {
                    e.preventDefault();
                    loadTasks(pagination.page + 1);
                });
            }
            paginationEl.appendChild(nextLi);
        }
        
        // 显示任务详情
        function showTaskDetail(taskId) {
            currentTaskId = taskId;
            
            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('taskDetailModal'));
            const modalBody = document.getElementById('taskDetailBody');
            
            // 显示加载状态
            modalBody.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                </div>
            `;
            
            modal.show();
            
            // 请求任务详情
            fetch(`/api/admin/tasks/${taskId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const task = data.data;
                        const statusText = task.status === 'completed' ? '已标注' : '待标注';
                        const completedAt = task.completed_at 
                            ? new Date(task.completed_at).toLocaleString() 
                            : '-';
                        
                        modalBody.innerHTML = `
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>基本信息</h6>
                                    <table class="table table-borderless">
                                        <tr>
                                            <td><strong>任务ID:</strong></td>
                                            <td>${task.id}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>状态:</strong></td>
                                            <td>
                                                ${task.status === 'completed' 
                                                    ? '<span class="badge bg-success">已标注</span>' 
                                                    : '<span class="badge bg-warning">待标注</span>'}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><strong>创建时间:</strong></td>
                                            <td>${new Date(task.created_at).toLocaleString()}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>完成时间:</strong></td>
                                            <td>${completedAt}</td>
                                        </tr>
                                    </table>
                                </div>
                                
                                <div class="col-md-6">
                                    <h6>图片信息 & 标注预览</h6>
                                    <div class="row">
                                        <div class="col-12 mb-2">
                                            <table class="table table-borderless">
                                                <tr>
                                                    <td><strong>文件名:</strong></td>
                                                    <td>${task.filename}</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>尺寸:</strong></td>
                                                    <td>${task.width} x ${task.height} 像素</td>
                                                </tr>
                                            </table>
                                        </div>
                                        <div class="col-12">
                                            <div id="annotationPreview" class="border rounded p-2" style="max-height:420px; overflow:auto;">
                                                <div class="d-flex justify-content-center">
                                                    <div class="position-relative w-100" style="text-align:center;">
                                                        <!-- 用隐藏的 canvas 绘制，导出为图片再显示 -->
                                                        <canvas id="annotationPreviewCanvas" class="d-none" style="max-width:100%; height:auto; border:1px solid #eee;"></canvas>
                                                        <img id="annotationPreviewImage" class="img-fluid d-none" alt="标注预览" style="border:1px solid #eee;" />
                                                        <div id="annotationPreviewMessage" class="text-muted small py-3">加载中...</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-12">
                                    <button class="btn btn-danger" id="deleteTaskBtn">
                                        <i class="fas fa-trash me-1"></i>删除任务
                                    </button>
                                    ${task.status === 'completed' ? `
                                    <button class="btn btn-warning ms-2" id="resetTaskBtn">
                                        <i class="fas fa-undo me-1"></i>重置任务
                                    </button>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                        
                        // 绑定删除按钮事件
                        document.getElementById('deleteTaskBtn').addEventListener('click', function() {
                            showDeleteConfirm(taskId);
                        });

                        // 绑定重置按钮（如果存在）
                        const resetBtn = document.getElementById('resetTaskBtn');
                        if (resetBtn) {
                            resetBtn.addEventListener('click', function() {
                                showResetConfirm(taskId);
                            });
                        }

                        // 渲染标注预览（如果有的话）。如果响应中没有 annotations 字段，单独请求 annotations 接口。
                        (async function() {
                            try {
                                let annotations = data.data.annotations;
                                if (!annotations || !Array.isArray(annotations) || annotations.length === 0) {
                                    try {
                                        const resp = await fetch(`/api/admin/tasks/${taskId}/annotations`);
                                        const annsJson = await resp.json();
                                        if (annsJson && annsJson.success && Array.isArray(annsJson.data)) {
                                            annotations = annsJson.data;
                                        }
                                    } catch (annErr) {
                                        console.warn('Failed to fetch annotations separately:', annErr);
                                    }
                                }

                                renderAnnotationPreview(task, annotations);
                            } catch (e) {
                                console.warn('Failed to render annotation preview:', e);
                            }
                        })();
                    } else {
                        modalBody.innerHTML = `
                            <div class="alert alert-danger" role="alert">
                                加载任务详情失败: ${data.error}
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    modalBody.innerHTML = `
                        <div class="alert alert-danger" role="alert">
                            网络错误，请稍后重试
                        </div>
                    `;
                });
        }
        
        // 显示删除确认对话框
        function showDeleteConfirm(taskId) {
            currentTaskId = taskId;
            const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            modal.show();
            
            // 绑定确认删除按钮事件
            document.getElementById('confirmDeleteBtn').onclick = function() {
                deleteTask(taskId);
                modal.hide();
            };
        }

        // 显示重置确认对话框
        function showResetConfirm(taskId) {
            currentTaskId = taskId;
            const modal = new bootstrap.Modal(document.getElementById('resetConfirmModal'));
            modal.show();

            document.getElementById('confirmResetBtn').onclick = function() {
                resetTask(taskId);
                modal.hide();
            };
        }

        // 重置任务（删除标注并设置为 pending）
        function resetTask(taskId) {
            fetch(`/api/admin/tasks/${taskId}/reset`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 隐藏详情模态框（如果打开的话）
                        const detailModalEl = document.getElementById('taskDetailModal');
                        if (bootstrap.Modal.getInstance(detailModalEl)) {
                            bootstrap.Modal.getInstance(detailModalEl).hide();
                        }
                        loadTasks(currentPage);
                        alert('任务已重置');
                    } else {
                        alert('重置失败: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('网络错误，请稍后重试');
                });
        }

        // ---------- 标注预览渲染 ----------
        function getTagColor(tag) {
            let hash = 0;
            for (let i = 0; i < tag.length; i++) {
                hash = ((hash << 5) - hash) + tag.charCodeAt(i);
                hash |= 0;
            }
            const h = Math.abs(hash) % 360;
            return `hsl(${h}, 70%, 45%)`;
        }

        function drawRoundedRect(ctx, x, y, w, h, r) {
            r = Math.min(r, w/2, h/2);
            ctx.beginPath();
            ctx.moveTo(x + r, y);
            ctx.arcTo(x + w, y, x + w, y + h, r);
            ctx.arcTo(x + w, y + h, x, y + h, r);
            ctx.arcTo(x, y + h, x, y, r);
            ctx.arcTo(x, y, x + w, y, r);
            ctx.closePath();
            ctx.fill();
        }

        function renderAnnotationPreview(task, annotations) {
            const canvas = document.getElementById('annotationPreviewCanvas');
            const message = document.getElementById('annotationPreviewMessage');
            const previewImg = document.getElementById('annotationPreviewImage');
            const ctx = canvas.getContext('2d');
            // 初始状态：提示可见，画布和图片隐藏
            message.classList.remove('d-none');
            message.textContent = '加载中...';
            canvas.classList.add('d-none');
            previewImg.classList.add('d-none');

            // 支持 annotations 为对象或数组，或为包含 content 字段的记录数组
            const annArray = Array.isArray(annotations) ? annotations : (annotations ? [annotations] : []);

            if (!annArray || annArray.length === 0) {
                canvas.classList.add('d-none');
                previewImg.classList.add('d-none');
                message.classList.remove('d-none');
                message.textContent = '该任务暂无标注内容';
                return;
            }

            // 解析每一条记录，支持直接对象或{ content: '...json...' } 形式；若是双重字符串也再解析一次
            const normalized = annArray.map(a => {
                if (!a) return null;
                if (a.polygons) return a;
                if (a.content) {
                    try {
                        let parsed = (typeof a.content === 'string') ? JSON.parse(a.content) : a.content;
                        if (typeof parsed === 'string') {
                            parsed = JSON.parse(parsed);
                        }
                        return parsed;
                    } catch (e) {
                        return null;
                    }
                }
                return a;
            }).filter(Boolean);

            const last = normalized.length > 0 ? normalized[normalized.length - 1] : null;
            const polygons = last && Array.isArray(last.polygons) ? last.polygons : [];

            if (!polygons || polygons.length === 0) {
                canvas.classList.add('d-none');
                previewImg.classList.add('d-none');
                message.classList.remove('d-none');
                message.textContent = '该任务暂无标注多边形';
                return;
            }

            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.onload = function() {
                message.textContent = '';
                message.classList.add('d-none');

                // 计算最大可用尺寸
                const container = document.getElementById('annotationPreview');
                const containerWidth = container && container.clientWidth ? container.clientWidth : img.width;
                const maxW = Math.min(Math.max(containerWidth - 20, 10), 800);
                const maxH = 420;
                const scale = Math.min(maxW / img.width, maxH / img.height, 1) || 1;

                // 设置canvas的实际绘图尺寸
                canvas.width = Math.round(img.width * scale);
                canvas.height = Math.round(img.height * scale);

                // 修复：确保canvas在容器内居中显示并保持比例
                canvas.style.width = canvas.width + 'px';
                canvas.style.height = canvas.height + 'px';
                canvas.style.display = 'block';
                canvas.style.margin = '0 auto';

                // 清理并绘制
                ctx.clearRect(0,0,canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                // 绘制每个多边形
                polygons.forEach(polygon => {
                    if (!polygon.points || polygon.points.length < 3) return;

                    ctx.beginPath();
                    const first = polygon.points[0];
                    ctx.moveTo(first.x * scale, first.y * scale);
                    for (let i = 1; i < polygon.points.length; i++) {
                        const p = polygon.points[i];
                        ctx.lineTo(p.x * scale, p.y * scale);
                    }
                    ctx.closePath();
                    ctx.strokeStyle = 'red';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    // 轻微填充以突出多边形区域，同时保持红色描边为主
                    // 半透明填充让区域更明显
                    ctx.fillStyle = 'rgba(255,0,0,0.35)';
                    ctx.fill();

                    // 标签
                    if (polygon.tag) {
                        const centroid = polygon.points.reduce((acc, p) => ({ x: acc.x + p.x, y: acc.y + p.y }), {x:0,y:0});
                        centroid.x /= polygon.points.length;
                        centroid.y /= polygon.points.length;
                        const cx = centroid.x * scale;
                        const cy = centroid.y * scale;

                        ctx.save();
                        ctx.font = 'bold 12px sans-serif';
                        ctx.textBaseline = 'middle';
                        ctx.textAlign = 'left';
                        const padding = 6;
                        const text = polygon.tag;
                        const metrics = ctx.measureText(text);
                        const textW = metrics.width;
                        const rectW = textW + padding*2;
                        const rectH = 18;

                        let left = cx + 6;
                        let top = cy - 6 - rectH;
                        if (left + rectW > canvas.width) left = canvas.width - rectW - 4;
                        if (left < 4) left = 4;
                        if (top + rectH > canvas.height) top = canvas.height - rectH - 4;
                        if (top < 4) top = 4;

                        const bg = getTagColor(text);
                        ctx.fillStyle = bg;
                        ctx.shadowColor = 'rgba(0,0,0,0.25)';
                        ctx.shadowBlur = 4;
                        ctx.shadowOffsetX = 0;
                        ctx.shadowOffsetY = 2;
                        drawRoundedRect(ctx, left, top, rectW, rectH, 6);

                        ctx.fillStyle = '#fff';
                        ctx.fillText(text, left + padding, top + rectH/2);
                        ctx.restore();
                    }
                });

                // 将绘制结果导出为图片，展示 img，保持 canvas 隐藏
                const dataUrl = canvas.toDataURL('image/png');
                previewImg.src = dataUrl;
                previewImg.classList.remove('d-none');
                canvas.classList.add('d-none');
            };

            img.onerror = function() {
                canvas.classList.add('d-none');
                previewImg.classList.add('d-none');
                message.classList.remove('d-none');
                message.textContent = '无法加载图片预览';
            };

            // 设置图片 src
            img.src = '/uploads/' + encodeURI(task.filename);
        }
        
        // 删除任务
        function deleteTask(taskId) {
            // 发送删除请求
            fetch(`/api/admin/tasks/${taskId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 隐藏任务详情模态框
                    const detailModal = bootstrap.Modal.getInstance(document.getElementById('taskDetailModal'));
                    detailModal.hide();
                    
                    // 重新加载任务列表
                    loadTasks(currentPage);
                    
                    // 显示成功消息
                    alert('任务删除成功');
                } else {
                    alert('删除失败: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('网络错误，请稍后重试');
            });
        }
        
        // 显示错误消息
        function showError(message) {
            const tbody = document.getElementById('tasksTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center text-danger">${message}</td>
                </tr>
            `;
        }
    </script>
</body>
</html>