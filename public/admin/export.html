<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据导出 - RockAnnotator</title>
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/all.min.css">
    <link href="/admin/css/style.css" rel="stylesheet">
</head>
<body>
    <div id="admin-navbar"></div>

    <div class="container-fluid">
        <div class="row dashboard-header mt-4">
            <div class="col-12">
                <h1>
                    <i class="fas fa-download me-2"></i>数据导出
                </h1>
                <p class="text-muted">选择时间范围，导出该时段内已标注的任务</p>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12 col-lg-10 col-xl-8">
                <div class="card">
                    <div class="card-header">
                        <strong><i class="fas fa-filter me-1"></i>导出条件</strong>
                    </div>
                    <div class="card-body">
                        <div id="exportAlert" class="alert d-none" role="alert"></div>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="startTime" class="form-label">开始时间</label>
                                <input type="datetime-local" class="form-control" id="startTime" />
                            </div>
                            <div class="col-md-6">
                                <label for="endTime" class="form-label">结束时间</label>
                                <input type="datetime-local" class="form-control" id="endTime" />
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">导出格式</label>
                                <input class="form-control" value="JSON（宋博士指定格式）" disabled />
                            </div>

                            <div class="col-md-6 d-flex align-items-end">
                                <div class="btn-group w-100">
                                    <button id="quickToday" type="button" class="btn btn-outline-secondary">今天</button>
                                    <button id="quick7" type="button" class="btn btn-outline-secondary">近7天</button>
                                    <button id="quick30" type="button" class="btn btn-outline-secondary">近30天</button>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="checkbox" value="1" id="onlyUnexported">
                                    <label class="form-check-label" for="onlyUnexported">
                                        仅导出未导出任务（已完成且未被导出）
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="mt-3 text-muted small">
                            <i class="fas fa-info-circle me-1"></i>
                            时间使用本地时区；导出时将转换为 ISO UTC（后端可按需解析）。
                        </div>

                        <div class="mt-4 d-flex">
                            <button id="exportBtn" class="btn btn-primary">
                                <span class="default-text"><i class="fas fa-file-export me-1"></i>导出</span>
                                <span class="loading-text d-none"><span class="spinner-border spinner-border-sm me-1"></span>正在导出...</span>
                            </button>
                            <button id="previewBtn" class="btn btn-outline-primary ms-2">
                                <i class="fas fa-eye me-1"></i>预览
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-header">
                        <strong><i class="fas fa-question-circle me-1"></i>说明</strong>
                    </div>
                    <div class="card-body">
                        <ul class="mb-0">
                            <li>导出范围以任务完成时间为准（已标注）。</li>
                            <li>导出为 JSON（LabelMe 兼容结构），一图一 JSON。</li>
                            <li>若后端暂未实现，点击导出会提示接口不可用。</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <script src="/admin/js/main.js"></script>
    <script>
                // 预览模态框 HTML 插入
                (function(){
                        const modalHtml = `
                        <div class="modal fade" id="exportPreviewModal" tabindex="-1" aria-hidden="true">
                            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">导出预览</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div id="previewCount" class="mb-2 text-muted"></div>
                                        <div class="table-responsive">
                                            <table class="table table-sm table-striped">
                                                <thead><tr><th>ID</th><th>文件</th><th>尺寸</th><th>完成时间</th></tr></thead>
                                                <tbody id="exportPreviewTableBody"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                        document.body.insertAdjacentHTML('beforeend', modalHtml);
                })();

        function setAlert(type, message) {
            const alert = document.getElementById('exportAlert');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alert.classList.remove('d-none');
        }

        function clearAlert() {
            const alert = document.getElementById('exportAlert');
            alert.className = 'alert d-none';
            alert.textContent = '';
        }

        function toISO(value) {
            // 从 datetime-local 值转换为 ISO 字符串（UTC）
            if (!value) return '';
            const d = new Date(value);
            if (isNaN(d.getTime())) return '';
            return d.toISOString();
        }

        function toggleLoading(loading) {
            const btn = document.getElementById('exportBtn');
            const def = btn.querySelector('.default-text');
            const load = btn.querySelector('.loading-text');
            btn.disabled = loading;
            def.classList.toggle('d-none', loading);
            load.classList.toggle('d-none', !loading);
        }

        function setQuickRange(days) {
            clearAlert();
            const end = new Date();
            const start = new Date();
            if (days === 'today') {
                // 今日 00:00 - 23:59
                start.setHours(0,0,0,0);
                end.setHours(23,59,59,999);
            } else {
                start.setDate(end.getDate() - days);
            }
            const fmt = (d) => {
                const pad = (n) => String(n).padStart(2,'0');
                const yyyy = d.getFullYear();
                const mm = pad(d.getMonth()+1);
                const dd = pad(d.getDate());
                const hh = pad(d.getHours());
                const mi = pad(d.getMinutes());
                return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
            };
            document.getElementById('startTime').value = fmt(start);
            document.getElementById('endTime').value = fmt(end);
        }

        async function doExport() {
            clearAlert();
            const startVal = document.getElementById('startTime').value;
            const endVal = document.getElementById('endTime').value;

            if (!startVal || !endVal) {
                setAlert('warning', '请先选择开始和结束时间');
                return;
            }
            const start = new Date(startVal);
            const end = new Date(endVal);
            if (isNaN(start) || isNaN(end)) {
                setAlert('danger', '时间格式无效，请重新选择');
                return;
            }
            if (start > end) {
                setAlert('warning', '开始时间不能晚于结束时间');
                return;
            }

            const onlyUnexported = document.getElementById('onlyUnexported').checked ? '1' : '0';
            const params = new URLSearchParams({ start: toISO(startVal), end: toISO(endVal), onlyUnexported });

            toggleLoading(true);
            try {
                const resp = await fetch(`/api/admin/export?${params.toString()}`);
                const data = await resp.json().catch(() => null);
                if (!resp.ok || !data || !data.success || !data.data || !data.data.zipPath) {
                    const msg = (data && data.error) ? data.error : '导出失败，接口未就绪';
                    setAlert('danger', msg);
                    return;
                }

                // 跳转到返回的 zip 路径触发下载
                window.location.href = data.data.zipPath;
                setAlert('success', '导出任务完成，正在下载 ZIP 文件');
            } catch (e) {
                console.error(e);
                setAlert('danger', '网络错误，请稍后重试');
            } finally {
                toggleLoading(false);
            }
        }

        async function doPreview() {
            clearAlert();
            const startVal = document.getElementById('startTime').value;
            const endVal = document.getElementById('endTime').value;

            if (!startVal || !endVal) {
                setAlert('warning', '请先选择开始和结束时间');
                return;
            }
            const start = new Date(startVal);
            const end = new Date(endVal);
            if (isNaN(start) || isNaN(end)) {
                setAlert('danger', '时间格式无效，请重新选择');
                return;
            }
            if (start > end) {
                setAlert('warning', '开始时间不能晚于结束时间');
                return;
            }

            const onlyUnexported = document.getElementById('onlyUnexported').checked ? '1' : '0';
            const params = new URLSearchParams({ start: toISO(startVal), end: toISO(endVal), onlyUnexported });

            try {
                const resp = await fetch(`/api/admin/export/preview?${params.toString()}`);
                const j = await resp.json().catch(() => null);
                if (!resp.ok || !j || !j.success) {
                    const msg = (j && j.error) ? j.error : '预览失败';
                    setAlert('danger', msg);
                    return;
                }

                const tasks = j.data || [];
                const tbody = document.getElementById('exportPreviewTableBody');
                tbody.innerHTML = '';
                if (tasks.length === 0) {
                    document.getElementById('previewCount').textContent = '无匹配任务';
                } else {
                    document.getElementById('previewCount').textContent = `共 ${tasks.length} 条任务将被导出（仅预览）`;
                    tasks.forEach(t => {
                        const completedAt = t.completed_at ? new Date(t.completed_at).toLocaleString() : '-';
                        const tr = document.createElement('tr');
                            tr.innerHTML = `<td>${t.id}</td><td>${t.filename}</td><td>${t.width} x ${t.height}</td><td>${completedAt}</td>`;
                        tbody.appendChild(tr);
                    });
                }

                const modalEl = document.getElementById('exportPreviewModal');
                const modal = new bootstrap.Modal(modalEl);
                modal.show();
            } catch (e) {
                console.error(e);
                setAlert('danger', '网络错误，请稍后重试');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('exportBtn').addEventListener('click', doExport);
            document.getElementById('previewBtn').addEventListener('click', doPreview);
            document.getElementById('quickToday').addEventListener('click', () => setQuickRange('today'));
            document.getElementById('quick7').addEventListener('click', () => setQuickRange(7));
            document.getElementById('quick30').addEventListener('click', () => setQuickRange(30));

            // 默认选近7天
            setQuickRange(7);
        });
    </script>
</body>
</html>